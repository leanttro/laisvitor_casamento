<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin | Laís & Vitor</title>
    <!-- Font Awesome & Google Fonts (Mesmas do Index) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Raleway:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- REUTILIZAÇÃO DAS VARIÁVEIS GLOBAIS --- */
        :root {
            --background: #2B2B2B;
            --surface: #3E3E3E;
            --border: #505050;
            --text-primary: #F5F5F5;
            --text-secondary: #B0B0B0;
            --accent-vinho: #9B2B3F;
            --accent-rosa: #DDC4C4;
            --font-body: 'Raleway', sans-serif;
            --font-heading: 'Cormorant Garamond', serif;
             /* Cores de Status para o Admin */
            --status-pending: #eebb00;
            --status-confirmed: #25D366;
            --status-rejected: #d32f2f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-body); background-color: var(--background);
            color: var(--text-secondary); line-height: 1.6;
            min-height: 100vh; display: flex; flex-direction: column;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        h1, h2, h3 { font-family: var(--font-heading); color: var(--text-primary); }

        /* --- UTILITÁRIOS E BOTÕES --- */
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background-color: var(--accent-vinho); color: var(--text-primary); }
        .btn-primary:hover { background-color: var(--chat-accent-hover); }
        .btn-danger { background-color: var(--status-rejected); color: var(--text-primary); }
        .btn-danger:hover { background-color: #a72323; }
        .btn-success { background-color: var(--status-confirmed); color: var(--text-primary); }
        .btn-success:hover { background-color: #1f9453; }
        .btn-action { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .error-msg { color: var(--status-rejected); margin-top: 1rem; display: none; }
        .success-msg { color: var(--status-confirmed); margin-top: 1rem; display: none; }
        
        /* --- TELA DE LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--background); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background-color: var(--surface); padding: 3rem; border-radius: 12px;
            border: 1px solid var(--border); width: 100%; max-width: 400px;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .login-box h2 { font-size: 2rem; margin-bottom: 2rem; color: var(--accent-rosa); }
        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: var(--text-primary); }
        .input-group input, .input-group textarea {
            width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border);
            background-color: var(--background); color: var(--text-primary); font-family: var(--font-body);
        }
        .input-group input:focus, .input-group textarea:focus { border-color: var(--accent-vinho); outline: none; }

        /* --- HEADER SIMPLIFICADO --- */
        header {
            padding: 1rem 0; background-color: var(--surface); border-bottom: 1px solid var(--border);
        }
        .admin-header { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: var(--font-heading); font-size: 1.5rem; color: var(--accent-rosa); font-weight: 700; text-decoration: none; }
        .btn-logout {
            padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--accent-vinho);
            color: var(--accent-vinho); border-radius: 6px; cursor: pointer; transition: all 0.3s;
        }
        .btn-logout:hover { background: var(--accent-vinho); color: var(--text-primary); }

        /* --- PAINEIS --- */
        #admin-panel { display: none; flex: 1; flex-direction: column; }

        /* --- HERO DO PAINEL --- */
        #admin-hero {
            background-image: url('historia.png'); /* Reuso de imagem */
            background-size: cover; background-position: center;
            padding: 80px 0; position: relative; color: white; text-align: center;
        }
        .hero-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(43, 43, 43, 0.85); }
        .hero-content { position: relative; z-index: 2; }
        #admin-hero h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        #admin-hero p { font-size: 1.2rem; color: var(--accent-rosa); }

        /* --- DASHBOARD BIG NUMBERS --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem; margin-top: -30px; position: relative; z-index: 3;
        }
        .stat-card {
            background-color: var(--surface); padding: 2rem; border-radius: 12px;
            border: 1px solid var(--border); text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .stat-number {
            font-family: var(--font-heading); font-size: 3rem; font-weight: 700;
            color: var(--accent-vinho); line-height: 1; margin-bottom: 0.5rem;
        }
        .stat-label { font-size: 1rem; color: var(--text-primary); font-weight: 500; }

        /* --- SEÇÕES DE GERENCIAMENTO --- */
        .admin-section { padding: 4rem 0; border-bottom: 1px solid var(--border); }
        .admin-section:nth-child(even) { background-color: var(--surface); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .section-header h2 { font-size: 2rem; }

        /* --- TABELAS E LISTAS --- */
        .admin-table {
            width: 100%; border-collapse: collapse; background-color: var(--background);
            border-radius: 8px; overflow: hidden; border: 1px solid var(--border);
        }
        .admin-table th, .admin-table td {
            padding: 1rem; text-align: left; border-bottom: 1px solid var(--border);
        }
        .admin-table th { background-color: rgba(0,0,0,0.2); color: var(--text-primary); font-weight: 600; }
        .status-badge {
            padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; color: #fff;
            display: inline-block;
        }
        .status-pending { background-color: var(--status-pending); color: #333; }
        .status-confirmed { background-color: var(--status-confirmed); }
        .status-rejected { background-color: var(--status-rejected); }

        /* --- CARDS DE MODERAÇÃO --- */
        .moderation-grid { display: grid; gap: 1rem; }
        .message-card {
            background-color: var(--background); padding: 1.5rem; border-radius: 8px;
            border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        }
        .message-content p { color: var(--text-primary); font-size: 1.1rem; margin-bottom: 0.5rem; }
        .message-author { color: var(--accent-rosa); font-size: 0.9rem; }
        .message-actions { display: flex; gap: 0.5rem; }
        
        .btn-approve { background-color: var(--status-confirmed); color: white; }
        .btn-reject { background-color: var(--status-rejected); color: white; }
        
        /* --- ESTILO GERAL DO MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8); z-index: 5000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--surface); padding: 2rem; border-radius: 12px;
            width: 90%; max-width: 500px; position: relative;
            border-top: 5px solid var(--accent-vinho);
            box-shadow: 0 15px 40px rgba(0,0,0,0.7);
        }
        .modal-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }
        .modal-content h3 { color: var(--accent-rosa); margin-bottom: 1rem; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
    </style>
</head>
<body>

    <!-- TELA DE LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>Acesso Restrito</h2>
            <form id="login-form">
                <div class="input-group">
                    <label for="username">Usuário</label>
                    <input type="text" id="username" required>
                </div>
                <div class="input-group">
                    <label for="password">Chave de Acesso</label>
                    <input type="password" id="password" required>
                </div>
                <!-- CORREÇÃO: Usamos type="button" e ID para garantir que o JS dispare, evitando o refresh nativo. -->
                <button type="button" class="btn btn-primary" id="login-button" style="width: 100%;">Entrar</button> 
                <p class="error-msg" id="login-error">Credenciais inválidas.</p>
            </form>
        </div>
    </div>

    <!-- PAINEL ADMINISTRATIVO (Inicialmente Oculto) -->
    <div id="admin-panel">
        <header>
            <div class="container admin-header">
                <a href="index.html" class="logo">Laís ♥ Vitor | Admin</a>
                <button class="btn-logout" id="logout-btn">Sair <i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <main>
            <!-- Hero Painel -->
            <section id="admin-hero">
                <div class="hero-overlay"></div>
                <div class="container hero-content">
                    <h1>Painel de Controle</h1>
                    <p>Bem-vindos de volta, Laís & Vitor</p>
                </div>
            </section>

            <div class="container">
                <!-- Big Numbers -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="stat-confirmed">-</div>
                        <div class="stat-label">Convidados Confirmados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-pending">-</div>
                        <div class="stat-label">RSVP Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-messages">-</div>
                        <div class="stat-label">Recados para Aprovar</div>
                    </div>
                </div>
            </div>

            <!-- Seção 1: Moderação de Recados -->
            <section class="admin-section">
                <div class="container">
                    <div class="section-header">
                        <h2>Moderação de Recados</h2>
                    </div>
                    <div class="moderation-grid" id="moderation-list">
                        <p style="color: var(--text-secondary);">Carregando recados...</p>
                        <!-- Recados serão carregados aqui via JS -->
                    </div>
                </div>
            </section>

            <!-- Seção 2: Gerenciar Presentes (Com Botão para Modal) -->
            <section class="admin-section">
                <div class="container">
                    <div class="section-header">
                        <h2>Gerenciar Presentes</h2>
                        <button class="btn btn-primary" id="open-add-gift-modal">+ Adicionar Novo Presente</button>
                    </div>
                    <table class="admin-table" id="gifts-table">
                        <thead>
                            <tr><th>Item</th><th>Valor (R$)</th><th>Status</th><th>Ações</th></tr>
                        </thead>
                        <tbody>
                            <tr id="gifts-loading"><td colspan="4" style="text-align: center;">Carregando lista de presentes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Seção 3: Lista de Convidados (Com Botão para Modal) -->
            <section class="admin-section">
                 <div class="container">
                    <div class="section-header">
                        <h2>Lista de Convidados</h2>
                        <div class="button-group">
                            <button class="btn btn-primary" id="open-add-convidado-modal">
                                <i class="fas fa-plus"></i> Adicionar Convidado
                            </button>
                            <button class="btn btn-primary">
                                <i class="fas fa-file-export"></i> Exportar CSV
                            </button>
                        </div>
                    </div>
                    <table class="admin-table" id="convidados-table">
                        <thead>
                            <tr><th>Código</th><th>Nome</th><th>Adultos</th><th>Restrições</th><th>Status RSVP</th><th>Ações</th></tr>
                        </thead>
                        <tbody>
                            <tr id="convidados-loading"><td colspan="6" style="text-align: center;">Carregando lista de convidados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- ------------------------------------------------------- -->
    <!-- --- MODAL DE ADICIONAR PRESENTE (FORMULÁRIO CRUD) --- -->
    <!-- ------------------------------------------------------- -->
    <div id="add-gift-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="close-add-gift-modal">&times;</button>
            <h3>Adicionar Novo Presente</h3>
            <form id="add-gift-form">
                <div class="input-group">
                    <label for="gift-name">Nome do Presente</label>
                    <input type="text" id="gift-name" required>
                </div>
                <div class="input-group">
                    <label for="gift-value">Valor da Cota (R$)</label>
                    <input type="number" id="gift-value" step="0.01" required>
                </div>
                <div class="input-group">
                    <label for="gift-url">URL da Imagem (Ex: presente.png)</label>
                    <input type="text" id="gift-url" value="presente_padrao.png" required>
                </div>
                 <div class="input-group">
                    <label for="gift-description">Descrição Curta</label>
                    <textarea id="gift-description" rows="3"></textarea>
                </div>
                <p class="error-msg" id="gift-error-msg">Erro ao salvar.</p>
                <p class="success-msg" id="gift-success-msg">Presente adicionado com sucesso!</p>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" id="cancel-add-gift">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="save-gift-btn">Salvar Presente</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ------------------------------------------------------- -->
    <!-- --- NOVO MODAL: ADICIONAR CONVIDADO (FORMULÁRIO CRUD) --- -->
    <!-- ------------------------------------------------------- -->
     <div id="add-convidado-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="close-add-convidado-modal">&times;</button>
            <h3>Adicionar Novo Convidado</h3>
            <form id="add-convidado-form">
                <div class="input-group">
                    <label for="convidado-name">Nome Completo/Família</label>
                    <input type="text" id="convidado-name" required>
                </div>
                <p class="error-msg" id="convidado-error-msg">Erro ao salvar.</p>
                <p class="success-msg" id="convidado-success-msg">Convidado adicionado! Código gerado: <strong id="new-codigo"></strong></p>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" id="cancel-add-convidado">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="save-convidado-btn">Gerar Código & Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- LIA Admin Placeholder -->
    <div style="position: fixed; bottom: 15px; right: 15px; cursor: pointer;" onclick="alert('LIA: Olá! Em breve, eu vou te ajudar a gerar relatórios e enviar lembretes por aqui!')">
        <div style="width: 60px; height: 60px; background: var(--accent-vinho); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
             <img src="casal.png" alt="LIA Admin" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; opacity: 0.9;">
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://laisvitor-casamento.onrender.com';
        let authToken = localStorage.getItem('admin_token');
        
        // --- FUNÇÕES DE UTILS ---
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        // --- FUNÇÕES DE AUTENTICAÇÃO ---
        function showPanel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'flex';
            loadDashboard(); // Carrega todos os dados
        }

        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('admin-panel').style.display = 'none';
            localStorage.removeItem('admin_token');
        }

        // NOVO: Função que lida com o login
        async function handleLogin(e) {
            if (e) e.preventDefault(); // Previne o refresh caso seja chamado pelo submit do form

            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-button');

            loginBtn.disabled = true;
            errorMsg.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/api/login_admin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, chave_admin: pass })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    localStorage.setItem('admin_token', authToken);
                    errorMsg.style.display = 'none';
                    showPanel();
                } else {
                    errorMsg.textContent = 'Usuário ou chave inválidos.';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro no login:', error);
                errorMsg.textContent = 'Erro ao conectar ao servidor.';
                errorMsg.style.display = 'block';
            } finally {
                loginBtn.disabled = false;
            }
        }

        // CORREÇÃO DE INICIALIZAÇÃO: Atribui a função de login a ambos os eventos (Clique e Enter no Form)
        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('login-form').addEventListener('submit', handleLogin); // Mantém o suporte ao Enter

        document.getElementById('logout-btn').addEventListener('click', showLogin);

        // --- CARREGAMENTO DO DASHBOARD (MÉTODO PRINCIPAL) ---
        async function loadDashboard() {
            if (!authToken) return showLogin();
            
            loadDashboardStats();
            loadGiftsTable();
            loadConvidadosTable(); // NOVO: Carrega a tabela de convidados
            // loadModerationList(); // Descomentar quando o GET for criado no app.py
        }
        
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/dashboard_stats`, { headers: getAuthHeaders() });
                if (response.ok) {
                    const stats = await response.json();
                    // Animação simples dos números
                    animateValue("stat-confirmed", 0, stats.confirmados, 1000);
                    animateValue("stat-pending", 0, stats.pendentes_rsvp, 1000);
                    animateValue("stat-messages", 0, stats.recados_moderacao, 1000);
                }
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
            }
        }
        
        // Função utilitária para animar números (Mantida do original)
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        // =============================================================
        // --- FUNÇÕES DE GERENCIAMENTO DE CONVIDADOS (NOVO) ---
        // =============================================================
        const convidadosTableBody = document.querySelector('#convidados-table tbody');
        const addConvidadoModal = document.getElementById('add-convidado-modal');
        const openConvidadoModalBtn = document.getElementById('open-add-convidado-modal');
        const closeConvidadoModalBtn = document.getElementById('close-add-convidado-modal');
        const addConvidadoForm = document.getElementById('add-convidado-form');
        const convidadoErrorMsgEl = document.getElementById('convidado-error-msg');
        const convidadoSuccessMsgEl = document.getElementById('convidado-success-msg');
        const newCodigoEl = document.getElementById('new-codigo');
        
        // ABRIR MODAL
        openConvidadoModalBtn.addEventListener('click', () => {
            addConvidadoModal.style.display = 'flex';
            addConvidadoForm.reset();
            convidadoErrorMsgEl.style.display = 'none';
            convidadoSuccessMsgEl.style.display = 'none';
        });
        // FECHAR MODAL
        closeConvidadoModalBtn.addEventListener('click', () => addConvidadoModal.style.display = 'none');
        document.getElementById('cancel-add-convidado').addEventListener('click', () => addConvidadoModal.style.display = 'none');
        
        // SUBMISSÃO DO FORMULÁRIO (POST /api/admin/convidados)
        addConvidadoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            convidadoErrorMsgEl.style.display = 'none';
            convidadoSuccessMsgEl.style.display = 'none';
            
            const convidadoName = document.getElementById('convidado-name').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/convidados`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ nome_convidado: convidadoName })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    newCodigoEl.textContent = data.codigo; // Exibe o código gerado
                    convidadoSuccessMsgEl.style.display = 'block';
                    loadConvidadosTable(); // Recarrega a tabela
                    loadDashboardStats(); // Atualiza contagem de pendentes
                    setTimeout(() => addConvidadoModal.style.display = 'none', 3000);
                } else {
                    const error = await response.json();
                    convidadoErrorMsgEl.textContent = error.mensagem || 'Falha ao adicionar convidado.';
                    convidadoErrorMsgEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao adicionar convidado:', error);
                convidadoErrorMsgEl.textContent = 'Erro de conexão com a API.';
                convidadoErrorMsgEl.style.display = 'block';
            }
        });
        
        // CARREGAR A TABELA DE CONVIDADOS (GET /api/admin/convidados)
        async function loadConvidadosTable() {
            convidadosTableBody.innerHTML = '<tr id="convidados-loading"><td colspan="6" style="text-align: center;">Carregando lista de convidados...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/convidados`, { headers: getAuthHeaders() });
                if (!response.ok) throw new Error('Falha ao carregar convidados admin');
                
                const convidados = await response.json();
                convidadosTableBody.innerHTML = '';
                
                convidados.forEach(c => {
                    let statusClass = 'status-pending';
                    let statusText = c.status_rsvp || 'Pendente';
                    if (statusText === 'Confirmado') statusClass = 'status-confirmed';
                    else if (statusText === 'Recusado') statusClass = 'status-rejected';

                    const row = convidadosTableBody.insertRow();
                    row.innerHTML = `
                        <td>${c.codigo_convite}</td>
                        <td>${c.nome_convidado}</td>
                        <td>${c.qtd_adultos || '-'}</td>
                        <td>${c.restricoes_alimentares || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                             <button class="btn-action" style="background:#555; color:white;">Editar</button>
                        </td>
                    `;
                });

            } catch (error) {
                console.error('Erro ao carregar lista de convidados:', error);
                convidadosTableBody.innerHTML = '<tr><td colspan="6" style="color:var(--status-rejected); text-align: center;">Erro ao carregar lista.</td></tr>';
            }
        }
        
        // =============================================================
        // --- FUNÇÕES DE GERENCIAMENTO DE PRESENTE (MANTIDAS) ---
        // =============================================================
        const giftsTableBody = document.querySelector('#gifts-table tbody');
        
        async function loadGiftsTable() {
            giftsTableBody.innerHTML = '<tr id="gifts-loading"><td colspan="4" style="text-align: center;">Carregando lista de presentes...</td></tr>';
            try {
                // Endpoint para ADMIN (inclui inativos)
                const response = await fetch(`${API_BASE_URL}/api/admin/presentes`, { headers: getAuthHeaders() });
                if (!response.ok) throw new Error('Falha ao carregar presentes admin');
                
                const gifts = await response.json();
                giftsTableBody.innerHTML = '';
                
                gifts.forEach(gift => {
                    const statusClass = gift.esta_ativo ? 'status-confirmed' : 'status-rejected';
                    const statusText = gift.esta_ativo ? 'Ativo' : 'Inativo';
                    
                    const row = giftsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${gift.nome_presente}</td>
                        <td>${formatCurrency(gift.valor_cota)}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn-action" style="background:#555; color:white;">Editar</button>
                            <button class="btn-action ${gift.esta_ativo ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleGiftStatus(${gift.id}, ${!gift.esta_ativo})">
                                ${gift.esta_ativo ? 'Desativar' : 'Ativar'}
                            </button>
                        </td>
                    `;
                });

            } catch (error) {
                console.error('Erro ao carregar lista de presentes (Admin):', error);
                giftsTableBody.innerHTML = '<tr><td colspan="4" style="color:var(--status-rejected); text-align: center;">Erro ao carregar lista.</td></tr>';
            }
        }
        
        // Função para ativar/desativar um presente (Chamará o PUT /api/admin/presentes/<id>/status)
        window.toggleGiftStatus = async function(giftId, newStatus) {
            if (!confirm(`Tem certeza que deseja ${newStatus ? 'ATIVAR' : 'DESATIVAR'} o presente ID ${giftId}?`)) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/presentes/${giftId}/status`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: newStatus })
                });
                if (response.ok) {
                    loadGiftsTable(); // Recarrega a tabela para atualizar o status
                    loadDashboardStats();
                } else {
                    alert('Falha ao alterar status.');
                }
            } catch (error) {
                console.error('Erro ao alternar status:', error);
            }
        }

        // --- LÓGICA DO MODAL DE ADICIONAR PRESENTE (MANTIDA) ---
        const addGiftModal = document.getElementById('add-gift-modal');
        const openModalBtn = document.getElementById('open-add-gift-modal');
        const closeModalBtn = document.getElementById('close-add-gift-modal');
        const addGiftForm = document.getElementById('add-gift-form');
        const errorMsgEl = document.getElementById('gift-error-msg');
        const successMsgEl = document.getElementById('gift-success-msg');

        openModalBtn.addEventListener('click', () => {
            addGiftModal.style.display = 'flex';
            addGiftForm.reset(); // Limpa o formulário ao abrir
            errorMsgEl.style.display = 'none';
            successMsgEl.style.display = 'none';
        });
        
        closeModalBtn.addEventListener('click', () => addGiftModal.style.display = 'none');
        document.getElementById('cancel-add-gift').addEventListener('click', () => addGiftModal.style.display = 'none');
        
        // Envio do formulário (Criação do presente)
        addGiftForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsgEl.style.display = 'none';
            successMsgEl.style.display = 'none';
            
            const giftData = {
                nome_presente: document.getElementById('gift-name').value,
                valor_cota: parseFloat(document.getElementById('gift-value').value),
                imagem_url: document.getElementById('gift-url').value,
                descricao: document.getElementById('gift-description').value,
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/presentes`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(giftData)
                });
                
                if (response.ok) {
                    successMsgEl.style.display = 'block';
                    loadGiftsTable(); // Recarrega a tabela
                    loadDashboardStats();
                    setTimeout(() => addGiftModal.style.display = 'none', 1500);
                } else {
                    const error = await response.json();
                    errorMsgEl.textContent = error.mensagem || 'Falha ao adicionar presente.';
                    errorMsgEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao adicionar presente:', error);
                errorMsgEl.textContent = 'Erro de conexão com a API.';
                errorMsgEl.style.display = 'block';
            }
        });


        // --- INICIALIZAÇÃO ---
        // Tenta carregar o painel se já houver token
        if (authToken) {
            showPanel();
        }
    </script>
</body>
</html>