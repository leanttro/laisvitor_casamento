<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin | Laís & Vitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Raleway:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- REUTILIZAÇÃO DAS VARIÁVEIS GLOBAIS --- */
        :root {
            --background: #2B2B2B;
            --surface: #3E3E3E;
            --border: #505050;
            --text-primary: #F5F5F5;
            --text-secondary: #B0B0B0;
            --accent-vinho: #9B2B3F;
            --accent-rosa: #DDC4C4;
            --font-body: 'Raleway', sans-serif;
            --font-heading: 'Cormorant Garamond', serif;
             /* Cores de Status para o Admin */
            --status-pending: #eebb00;
            --status-confirmed: #25D366;
            --status-rejected: #d32f2f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-body); background-color: var(--background);
            color: var(--text-secondary); line-height: 1.6;
            min-height: 100vh; display: flex; flex-direction: column;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        h1, h2, h3 { font-family: var(--font-heading); color: var(--text-primary); }

        /* --- UTILITÁRIOS E BOTÕES --- */
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background-color: var(--accent-vinho); color: var(--text-primary); }
        .btn-primary:hover { background-color: #7c2232; }
        .btn-danger { background-color: var(--status-rejected); color: var(--text-primary); }
        .btn-danger:hover { background-color: #a72323; }
        .btn-success { background-color: var(--status-confirmed); color: var(--text-primary); }
        .btn-success:hover { background-color: #1f9453; }
        .btn-action { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .error-msg { color: var(--status-rejected); margin-top: 1rem; display: none; }
        .success-msg { color: var(--status-confirmed); margin-top: 1rem; display: none; }
        
        /* --- TELA DE LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--background); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background-color: var(--surface); padding: 3rem; border-radius: 12px;
            border: 1px solid var(--border); width: 100%; max-width: 400px;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .login-box h2 { font-size: 2rem; margin-bottom: 2rem; color: var(--accent-rosa); }
        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: var(--text-primary); }
        .input-group input, .input-group textarea, .input-group select { /* Adicionado select */
            width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border);
            background-color: var(--background); color: var(--text-primary); font-family: var(--font-body);
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { border-color: var(--accent-vinho); outline: none; }

        /* --- HEADER SIMPLIFICADO --- */
        header {
            padding: 1rem 0; background-color: var(--surface); border-bottom: 1px solid var(--border);
        }
        .admin-header { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: var(--font-heading); font-size: 1.5rem; color: var(--accent-rosa); font-weight: 700; text-decoration: none; }
        .btn-logout {
            padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--accent-vinho);
            color: var(--accent-vinho); border-radius: 6px; cursor: pointer; transition: all 0.3s;
        }
        .btn-logout:hover { background: var(--accent-vinho); color: var(--text-primary); }

        /* --- PAINEIS --- */
        #admin-panel { display: none; flex: 1; flex-direction: column; }

        /* --- HERO DO PAINEL --- */
        #admin-hero {
            background-image: url('historia.png'); /* Reuso de imagem */
            background-size: cover; background-position: center;
            padding: 80px 0; position: relative; color: white; text-align: center;
        }
        .hero-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(43, 43, 43, 0.85); }
        .hero-content { position: relative; z-index: 2; }
        #admin-hero h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        #admin-hero p { font-size: 1.2rem; color: var(--accent-rosa); }

        /* --- DASHBOARD BIG NUMBERS --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem; margin-top: -30px; position: relative; z-index: 3;
        }
        .stat-card {
            background-color: var(--surface); padding: 2rem; border-radius: 12px;
            border: 1px solid var(--border); text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .stat-number {
            font-family: var(--font-heading); font-size: 3rem; font-weight: 700;
            color: var(--text-primary);
            line-height: 1; margin-bottom: 0.5rem;
        }
        .stat-label { font-size: 1rem; color: var(--text-primary); font-weight: 500; }

        /* --- SEÇÕES DE GERENCIAMENTO --- */
        .admin-section { padding: 4rem 0; border-bottom: 1px solid var(--border); }
        .admin-section:nth-child(even) { background-color: var(--surface); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .section-header h2 { font-size: 2rem; }

        /* --- TABELAS E LISTAS --- */
        .admin-table {
            width: 100%; border-collapse: collapse; background-color: var(--background);
            border-radius: 8px; overflow: hidden; border: 1px solid var(--border);
        }
        .admin-table th, .admin-table td {
            padding: 1rem; text-align: left; border-bottom: 1px solid var(--border);
        }
        .admin-table th { background-color: rgba(0,0,0,0.2); color: var(--text-primary); font-weight: 600; }
        .status-badge {
            padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; color: #fff;
            display: inline-block;
        }
        .status-pending { background-color: var(--status-pending); color: #333; }
        .status-confirmed { background-color: var(--status-confirmed); }
        .status-rejected { background-color: var(--status-rejected); }

        /* --- CARDS DE MODERAÇÃO --- */
        .moderation-grid { display: grid; gap: 1rem; }
        .message-card {
            background-color: var(--background); padding: 1.5rem; border-radius: 8px;
            border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        }
        .message-content p { color: var(--text-primary); font-size: 1.1rem; margin-bottom: 0.5rem; }
        .message-author { color: var(--accent-rosa); font-size: 0.9rem; }
        .message-actions { display: flex; gap: 0.5rem; }
        
        .btn-approve { background-color: var(--status-confirmed); color: white; }
        .btn-reject { background-color: var(--status-rejected); color: white; }
        
        /* --- ESTILO GERAL DO MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8); z-index: 5000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--surface); padding: 2rem; border-radius: 12px;
            width: 90%; max-width: 500px; position: relative;
            border-top: 5px solid var(--accent-vinho);
            box-shadow: 0 15px 40px rgba(0,0,0,0.7);
        }
        .modal-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }
        .modal-content h3 { color: var(--accent-rosa); margin-bottom: 1rem; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Acesso Restrito</h2>
            <form id="login-form">
                <div class="input-group">
                    <label for="username">Usuário</label>
                    <input type="text" id="username" required>
                </div>
                <div class="input-group">
                    <label for="password">Chave de Acesso</label>
                    <input type="password" id="password" required>
                </div>
                <button type="button" class="btn btn-primary" id="login-button" style="width: 100%;">Entrar</button> 
                <p class="error-msg" id="login-error">Credenciais inválidas.</p>
            </form>
        </div>
    </div>

    <div id="admin-panel">
        <header>
            <div class="container admin-header">
                <a href="index.html" class="logo">Laís ♥ Vitor | Admin</a>
                <button class="btn-logout" id="logout-btn">Sair <i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <main>
            <section id="admin-hero">
                <div class="hero-overlay"></div>
                <div class="container hero-content">
                    <h1>Painel de Controle</h1>
                    <p>Bem-vindos de volta, Laís & Vitor</p>
                </div>
            </section>

            <div class="container">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="stat-confirmed">-</div>
                        <div class="stat-label">Convidados Confirmados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-pending">-</div>
                        <div class="stat-label">RSVP Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-messages">-</div>
                        <div class="stat-label">Recados para Aprovar</div>
                    </div>
                </div>
            </div>

            <section class="admin-section">
                <div class="container">
                    <div class="section-header">
                        <h2>Moderação de Recados</h2>
                    </div>
                    <div class="moderation-grid" id="moderation-list">
                        <p style="color: var(--text-secondary);">Carregando recados...</p>
                        </div>
                </div>
            </section>

            <section class="admin-section">
                <div class="container">
                    <div class="section-header">
                        <h2>Gerenciar Presentes</h2>
                        <button class="btn btn-primary" id="open-add-gift-modal">+ Adicionar Novo Presente</button>
                    </div>
                    <table class="admin-table" id="gifts-table">
                        <thead>
                            <tr><th>Item</th><th>Valor (R$)</th><th>Status</th><th>Ações</th></tr>
                        </thead>
                        <tbody>
                            <tr id="gifts-loading"><td colspan="4" style="text-align: center;">Carregando lista de presentes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="admin-section">
                 <div class="container">
                    <div class="section-header">
                        <h2>Lista de Convidados</h2>
                        <div class="button-group">
                            <button class="btn btn-primary" id="open-add-convidado-modal">
                                <i class="fas fa-plus"></i> Adicionar Convidado
                            </button>
                            <button class="btn btn-primary">
                                <i class="fas fa-file-export"></i> Exportar CSV
                            </button>
                        </div>
                    </div>
                    <table class="admin-table" id="convidados-table">
                        <thead>
                            <tr><th>Código</th><th>Nome</th><th>Adultos</th><th>Restrições</th><th>Status RSVP</th><th>Ações</th></tr>
                        </thead>
                        <tbody>
                            <tr id="convidados-loading"><td colspan="6" style="text-align: center;">Carregando lista de convidados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="add-gift-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="close-add-gift-modal">&times;</button>
            <h3 id="gift-modal-title">Adicionar Novo Presente</h3> <form id="add-gift-form">
                <input type="hidden" id="gift-id"> <div class="input-group">
                    <label for="gift-name">Nome do Presente</label>
                    <input type="text" id="gift-name" required>
                </div>
                <div class="input-group">
                    <label for="gift-value">Valor da Cota (R$)</label>
                    <input type="number" id="gift-value" step="0.01" required>
                </div>
                <div class="input-group">
                    <label for="gift-url">URL da Imagem (Ex: presente.png)</label>
                    <input type="text" id="gift-url" value="presente_padrao.png" required>
                </div>
                 <div class="input-group">
                    <label for="gift-description">Descrição Curta</label>
                    <textarea id="gift-description" rows="3"></textarea>
                </div>
                <p class="error-msg" id="gift-error-msg">Erro ao salvar.</p>
                <p class="success-msg" id="gift-success-msg">Presente adicionado com sucesso!</p>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" id="cancel-add-gift">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="save-gift-btn">Salvar Presente</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-convidado-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="close-add-convidado-modal">&times;</button>
            <h3>Adicionar Novo Convidado</h3>
            <form id="add-convidado-form">
                <div class="input-group">
                    <label for="convidado-name">Nome Completo/Família</label>
                    <input type="text" id="convidado-name" required>
                </div>
                <p class="error-msg" id="convidado-error-msg">Erro ao salvar.</p>
                <p class="success-msg" id="convidado-success-msg">Convidado adicionado! Código gerado: <strong id="new-codigo"></strong></p>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" id="cancel-add-convidado">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="save-convidado-btn">Gerar Código & Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-convidado-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="close-edit-convidado-modal">&times;</button>
            <h3>Editar Convidado</h3>
            <form id="update-convidado-form">
                <input type="hidden" id="update-convidado-id"> 
                <div class="input-group">
                    <label for="update-convidado-name">Nome Completo/Família</label>
                    <input type="text" id="update-convidado-name" required>
                </div>
                <div class="input-group">
                    <label for="update-convidado-codigo">Código de Convite</label>
                    <input type="text" id="update-convidado-codigo" readonly>
                </div>
                <div class="input-group">
                    <label for="update-convidado-status">Status RSVP</label>
                    <select id="update-convidado-status" required>
                        <option value="Pendente">Pendente</option>
                        <option value="Confirmado">Confirmado</option>
                        <option value="Recusado">Recusado</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="update-convidado-adultos">Qtd. Adultos</label>
                    <input type="number" id="update-convidado-adultos" min="0">
                </div>
                <div class="input-group">
                    <label for="update-convidado-restricoes">Restrições Alimentares</label>
                    <textarea id="update-convidado-restricoes" rows="2"></textarea>
                </div>

                <p class="error-msg" id="update-convidado-error-msg">Erro ao atualizar.</p>
                <p class="success-msg" id="update-convidado-success-msg">Convidado atualizado com sucesso!</p>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" id="cancel-update-convidado">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="save-update-convidado-btn">Atualizar Dados</button>
                </div>
            </form>
        </div>
    </div>


    <div style="position: fixed; bottom: 15px; right: 15px; cursor: pointer;" onclick="console.log('LIA: Funcionalidades futuras como relatórios e lembretes serão adicionadas aqui!')">
        <div style="width: 60px; height: 60px; background: var(--accent-vinho); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
             <img src="casal.png" alt="LIA Admin" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; opacity: 0.9;">
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://laisvitor-casamento.onrender.com';

        // --- VARIÁVEIS GLOBAIS PARA O CRUD DE PRESENTES ---
        const addGiftModal = document.getElementById('add-gift-modal');
        const giftModalTitleEl = document.getElementById('gift-modal-title');
        const addGiftForm = document.getElementById('add-gift-form');
        const saveGiftBtn = document.getElementById('save-gift-btn');
        const giftIdInput = document.getElementById('gift-id');
        const giftNameInput = document.getElementById('gift-name');
        const giftValueInput = document.getElementById('gift-value');
        const giftUrlInput = document.getElementById('gift-url');
        const giftDescriptionInput = document.getElementById('gift-description');
        const giftsTableBody = document.querySelector('#gifts-table tbody');
        const errorMsgEl = document.getElementById('gift-error-msg');
        const successMsgEl = document.getElementById('gift-success-msg');
        
        let isEditingGift = false; // Flag para controlar se está editando ou criando
        // ----------------------------------------------------


        // --- FUNÇÕES DE UTILS ---
        function getAuthHeaders() {
            // LÊ O TOKEN SEMPRE DO LOCAL STORAGE, GARANTINDO QUE O VALOR SEJA O MAIS ATUALIZADO APÓS O LOGIN
            const token = localStorage.getItem('admin_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        // --- FUNÇÕES DE AUTENTICAÇÃO ---
        function showPanel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'flex';
            loadDashboard(); // Carrega todos os dados
        }

        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('admin-panel').style.display = 'none';
            localStorage.removeItem('admin_token');
        }

        // --- Lógica de Login ---
        async function handleLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');

            try {
                const response = await fetch(`${API_BASE_URL}/api/login_admin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, chave_admin: pass })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('admin_token', data.token); // Salva o token
                    errorMsg.style.display = 'none';
                    showPanel();
                } else {
                    errorMsg.textContent = 'Usuário ou chave inválidos.';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro no login:', error);
                errorMsg.textContent = 'Erro ao conectar ao servidor.';
                errorMsg.style.display = 'block';
            }
        }
        
        document.getElementById('login-button').addEventListener('click', handleLogin); 
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleLogin();
        });


        document.getElementById('logout-btn').addEventListener('click', showLogin);

        // --- CARREGAMENTO DO DASHBOARD (MÉTODO PRINCIPAL) ---
        async function loadDashboard() {
            // Verifica o token no localStorage
            if (!localStorage.getItem('admin_token')) return showLogin();
            
            loadDashboardStats();
            loadGiftsTable();
            loadConvidadosTable(); 
            loadModerationList();
        }
        
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/dashboard_stats`, { headers: getAuthHeaders() });
                if (response.ok) {
                    const stats = await response.json();
                    animateValue("stat-confirmed", 0, stats.confirmados, 1000);
                    animateValue("stat-pending", 0, stats.pendentes_rsvp, 1000);
                    animateValue("stat-messages", 0, stats.recados_moderacao, 1000);
                } else if (response.status === 403) {
                     // ERRO 403 (FORBIDDEN) -> Token expirado ou inválido
                    showLogin();
                    console.error("Token inválido ou expirado. Redirecionando para login.");
                }
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
            }
        }
        
        // Função utilitária para animar números
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        // =============================================================
        // --- FUNÇÕES DE MODERAÇÃO DE RECADOS ---
        // =============================================================
        const moderationListEl = document.getElementById('moderation-list');

        async function loadModerationList() {
            moderationListEl.innerHTML = '<p style="color: var(--text-secondary);">Carregando recados...</p>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/depoimentos/pendentes`, { headers: getAuthHeaders() });
                if (!response.ok) {
                    if (response.status === 403) {
                        moderationListEl.innerHTML = '<p style="color:var(--status-rejected);">Autorização Expirada. Por favor, faça o login novamente.</p>';
                        showLogin();
                        return;
                    }
                    throw new Error('Falha ao carregar recados pendentes');
                }
                
                const recados = await response.json();
                moderationListEl.innerHTML = '';
                
                if (recados.length === 0) {
                    moderationListEl.innerHTML = '<p style="color: var(--text-secondary);">Nenhum recado pendente de moderação.</p>';
                    return;
                }

                recados.forEach(r => {
                    const card = document.createElement('div');
                    card.className = 'message-card';
                    card.dataset.id = r.id; 

                    card.innerHTML = `
                        <div class="message-content">
                            <p>"${r.mensagem}"</p>
                            <span class="message-author">Enviado por: ${r.nome_convidado}</span>
                        </div>
                        <div class="message-actions">
                            <button class="btn-action btn-approve" onclick="handleModeration(${r.id}, 'Aprovado')">Aprovar</button>
                            <button class="btn-action btn-reject" onclick="handleModeration(${r.id}, 'Rejeitado')">Rejeitar</button>
                        </div>
                    `;
                    moderationListEl.appendChild(card);
                });

            } catch (error) {
                console.error('Erro ao carregar lista de moderação:', error);
                moderationListEl.innerHTML = '<p style="color:var(--status-rejected);">Erro ao carregar lista.</p>';
            }
        }
        
        window.handleModeration = async function(depoimentoId, status) {
            const confirmed = confirm(`Tem certeza que deseja ${status.toLowerCase()} o recado?`);
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/depoimentos/${depoimentoId}/status`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: status })
                });

                if (response.ok) {
                    // Atualiza ambas as listas e o contador
                    loadModerationList(); 
                    loadDashboardStats();
                } else if (response.status === 403) {
                     alert('Falha de Autorização (403). Redirecionando para login.');
                     showLogin();
                } else {
                    alert('Falha ao atualizar status do recado.');
                }

            } catch (error) {
                console.error('Erro ao moderar recado:', error);
                alert('Erro de conexão ao servidor ao tentar moderar.');
            }
        }

        // =============================================================
        // --- FUNÇÕES DE GERENCIAMENTO DE CONVIDADOS ---
        // =============================================================
        const convidadosTableBody = document.querySelector('#convidados-table tbody');
        const addConvidadoModal = document.getElementById('add-convidado-modal');
        const editConvidadoModal = document.getElementById('edit-convidado-modal'); // Novo Modal
        const openConvidadoModalBtn = document.getElementById('open-add-convidado-modal');
        const closeConvidadoModalBtn = document.getElementById('close-add-convidado-modal');
        const closeEditConvidadoModalBtn = document.getElementById('close-edit-convidado-modal'); // Botão Fechar Edição
        const addConvidadoForm = document.getElementById('add-convidado-form');
        const updateConvidadoForm = document.getElementById('update-convidado-form'); // Novo Form
        const convidadoErrorMsgEl = document.getElementById('convidado-error-msg');
        const convidadoSuccessMsgEl = document.getElementById('convidado-success-msg');
        const newCodigoEl = document.getElementById('new-codigo');
        
        // VARIÁVEIS DO MODAL DE EDIÇÃO
        const updateConvidadoIdInput = document.getElementById('update-convidado-id');
        const updateConvidadoNameInput = document.getElementById('update-convidado-name');
        const updateConvidadoCodigoInput = document.getElementById('update-convidado-codigo');
        const updateConvidadoStatusSelect = document.getElementById('update-convidado-status');
        const updateConvidadoAdultosInput = document.getElementById('update-convidado-adultos');
        const updateConvidadoRestricoesTextarea = document.getElementById('update-convidado-restricoes');
        const updateConvidadoErrorMsgEl = document.getElementById('update-convidado-error-msg');
        const updateConvidadoSuccessMsgEl = document.getElementById('update-convidado-success-msg');


        // ABRIR MODAL ADICIONAR
        openConvidadoModalBtn.addEventListener('click', () => {
            addConvidadoModal.style.display = 'flex';
            addConvidadoForm.reset();
            convidadoErrorMsgEl.style.display = 'none';
            convidadoSuccessMsgEl.style.display = 'none';
        });
        // FECHAR MODAL ADICIONAR
        closeConvidadoModalBtn.addEventListener('click', () => addConvidadoModal.style.display = 'none');
        document.getElementById('cancel-add-convidado').addEventListener('click', () => addConvidadoModal.style.display = 'none');
        
        // FECHAR MODAL EDIÇÃO
        closeEditConvidadoModalBtn.addEventListener('click', () => editConvidadoModal.style.display = 'none');
        document.getElementById('cancel-update-convidado').addEventListener('click', () => editConvidadoModal.style.display = 'none');


        // SUBMISSÃO DO FORMULÁRIO (POST /api/admin/convidados)
        addConvidadoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            convidadoErrorMsgEl.style.display = 'none';
            convidadoSuccessMsgEl.style.display = 'none';
            
            const convidadoName = document.getElementById('convidado-name').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/convidados`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ nome_convidado: convidadoName })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    newCodigoEl.textContent = data.codigo; // Exibe o código gerado
                    convidadoSuccessMsgEl.style.display = 'block';
                    
                    // --- CORREÇÃO DO BUG: Tenta recarregar a tabela e estatísticas, mas garante que a mensagem de sucesso seja exibida antes ---
                    loadConvidadosTable(); // Recarrega a tabela
                    loadDashboardStats(); // Atualiza contagem de pendentes
                    // ---------------------------------------------------------------------------------------------------------------------------------

                    setTimeout(() => addConvidadoModal.style.display = 'none', 3000);
                } else if (response.status === 403) {
                    convidadoErrorMsgEl.textContent = 'Falha de Autorização (403). Relogue.';
                    convidadoErrorMsgEl.style.display = 'block';
                    showLogin();
                } else {
                    const error = await response.json();
                    convidadoErrorMsgEl.textContent = error.mensagem || 'Falha ao adicionar convidado.';
                    convidadoErrorMsgEl.style.display = 'block';
                }
            } catch (error) {
                // ESTE CATCH É DISPARADO SE O loadConvidadosTable() FALHAR, MESMO COM SUCESSO DO POST.
                // Mas a mensagem de sucesso já foi exibida acima. MANTEMOS A MENSAGEM GENÉRICA APENAS SE HOUVER ERRO REAL NO POST.
                console.error('Erro ao adicionar convidado:', error);
                if (convidadoSuccessMsgEl.style.display !== 'block') {
                    convidadoErrorMsgEl.textContent = 'Erro de conexão com a API.';
                    convidadoErrorMsgEl.style.display = 'block';
                }
            }
        });

        // SUBMISSÃO DO FORMULÁRIO (PUT /api/admin/convidados/<id>)
        updateConvidadoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            updateConvidadoErrorMsgEl.style.display = 'none';
            updateConvidadoSuccessMsgEl.style.display = 'none';
            
            const convidadoId = updateConvidadoIdInput.value;

            const convidadoData = {
                nome_convidado: updateConvidadoNameInput.value,
                status_rsvp: updateConvidadoStatusSelect.value,
                qtd_adultos: parseInt(updateConvidadoAdultosInput.value) || 0,
                restricoes_alimentares: updateConvidadoRestricoesTextarea.value,
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/convidados/${convidadoId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(convidadoData)
                });
                
                if (response.ok) {
                    updateConvidadoSuccessMsgEl.textContent = 'Convidado atualizado com sucesso!';
                    updateConvidadoSuccessMsgEl.style.display = 'block';
                    loadConvidadosTable(); // Recarrega a tabela
                    loadDashboardStats(); // Atualiza contagem
                    setTimeout(() => editConvidadoModal.style.display = 'none', 1500);
                } else if (response.status === 403) {
                    updateConvidadoErrorMsgEl.textContent = 'Falha de Autorização (403). Relogue.';
                    updateConvidadoErrorMsgEl.style.display = 'block';
                    showLogin();
                } else {
                    const error = await response.json();
                    updateConvidadoErrorMsgEl.textContent = error.mensagem || 'Falha ao atualizar convidado.';
                    updateConvidadoErrorMsgEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao atualizar convidado:', error);
                updateConvidadoErrorMsgEl.textContent = 'Erro de conexão com a API.';
                updateConvidadoErrorMsgEl.style.display = 'block';
            }
        });

        
        // FUNÇÃO PARA ABRIR O MODAL DE EDIÇÃO (GET /api/convidados/<id>)
        window.editConvidado = async function(convidadoId) {
            updateConvidadoErrorMsgEl.style.display = 'none';
            updateConvidadoSuccessMsgEl.style.display = 'none';

            try {
                // 1. Buscando dados do convidado
                const response = await fetch(`${API_BASE_URL}/api/convidados/${convidadoId}`, { headers: getAuthHeaders() });
                if (response.status === 404) throw new Error("Convidado não encontrado.");
                if (response.status === 403) { showLogin(); return; }
                if (!response.ok) throw new Error("Erro ao carregar dados do convidado.");

                const convidado = await response.json();
                
                // 2. Preencher o Modal
                updateConvidadoIdInput.value = convidado.id; // ID oculto para o PUT
                updateConvidadoNameInput.value = convidado.nome_convidado;
                updateConvidadoCodigoInput.value = convidado.codigo_convite; // Apenas leitura
                updateConvidadoStatusSelect.value = convidado.status_rsvp || 'Pendente';
                updateConvidadoAdultosInput.value = convidado.qtd_adultos || 0;
                updateConvidadoRestricoesTextarea.value = convidado.restricoes_alimentares || '';

                // 3. Abrir o Modal
                editConvidadoModal.style.display = 'flex';

            } catch (error) {
                console.error('Erro ao editar convidado:', error);
                alert('Não foi possível carregar os dados para edição.');
            }
        }

        // CARREGAR A TABELA DE CONVIDADOS (GET /api/admin/convidados)
        async function loadConvidadosTable() {
            convidadosTableBody.innerHTML = '<tr id="convidados-loading"><td colspan="6" style="text-align: center;">Carregando lista de convidados...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/convidados`, { headers: getAuthHeaders() });
                if (!response.ok) {
                    if (response.status === 403) {
                        convidadosTableBody.innerHTML = '<tr><td colspan="6" style="color:var(--status-rejected); text-align: center;">Autorização Expirada. Por favor, faça o login novamente.</td></tr>';
                        showLogin();
                        return;
                    }
                    throw new Error('Falha ao carregar convidados admin');
                }
                
                const convidados = await response.json();
                convidadosTableBody.innerHTML = '';
                
                convidados.forEach(c => {
                    let statusClass = 'status-pending';
                    let statusText = c.status_rsvp || 'Pendente';
                    if (statusText === 'Confirmado') statusClass = 'status-confirmed';
                    else if (statusText === 'Recusado') statusClass = 'status-rejected';

                    const row = convidadosTableBody.insertRow();
                    row.innerHTML = `
                        <td>${c.codigo_convite}</td>
                        <td>${c.nome_convidado}</td>
                        <td>${c.qtd_adultos || '-'}</td>
                        <td>${c.restricoes_alimentares || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                             <button class="btn-action" style="background:#555; color:white;" onclick="editConvidado(${c.id})">Editar</button>
                        </td>
                    `;
                });

            } catch (error) {
                console.error('Erro ao carregar lista de convidados:', error);
                convidadosTableBody.innerHTML = '<tr><td colspan="6" style="color:var(--status-rejected); text-align: center;">Erro ao carregar lista.</td></tr>';
            }
        }
        
        // =============================================================
        // --- FUNÇÕES DE GERENCIAMENTO DE PRESENTE ---
        // =============================================================
        
        async function loadGiftsTable() {
            giftsTableBody.innerHTML = '<tr id="gifts-loading"><td colspan="4" style="text-align: center;">Carregando lista de presentes...</td></tr>';
            try {
                // Endpoint para ADMIN (inclui inativos)
                const response = await fetch(`${API_BASE_URL}/api/admin/presentes`, { headers: getAuthHeaders() });
                if (!response.ok) {
                    if (response.status === 403) {
                         // Trata 403
                         giftsTableBody.innerHTML = '<tr><td colspan="4" style="color:var(--status-rejected); text-align: center;">Autorização Expirada. Por favor, faça o login novamente.</td></tr>';
                         showLogin();
                         return;
                    }
                    throw new Error('Falha ao carregar presentes admin');
                }
                
                const gifts = await response.json();
                giftsTableBody.innerHTML = '';
                
                gifts.forEach(gift => {
                    const statusClass = gift.esta_ativo ? 'status-confirmed' : 'status-rejected';
                    const statusText = gift.esta_ativo ? 'Ativo' : 'Inativo';
                    
                    const row = giftsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${gift.nome_presente}</td>
                        <td>${formatCurrency(gift.valor_cota)}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn-action" style="background:#555; color:white;" onclick="editGift(${gift.id})">Editar</button>
                            <button class="btn-action ${gift.esta_ativo ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleGiftStatus(${gift.id}, ${!gift.esta_ativo})">
                                ${gift.esta_ativo ? 'Desativar' : 'Ativar'}
                            </button>
                        </td>
                    `;
                });

            } catch (error) {
                console.error('Erro ao carregar lista de presentes (Admin):', error);
                giftsTableBody.innerHTML = '<tr><td colspan="4" style="color:var(--status-rejected); text-align: center;">Erro ao carregar lista.</td></tr>';
            }
        }
        
        // Função para ativar/desativar um presente (Chamará o PUT /api/admin/presentes/<id>/status)
        window.toggleGiftStatus = async function(giftId, newStatus) {
            if (!confirm(`Tem certeza que deseja ${newStatus ? 'ATIVAR' : 'DESATIVAR'} o presente ID ${giftId}?`)) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/presentes/${giftId}/status`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: newStatus })
                });
                if (response.ok) {
                    loadGiftsTable(); // Recarrega a tabela para atualizar o status
                    loadDashboardStats();
                } else if (response.status === 403) {
                    alert('Falha de Autorização (403). Relogue.');
                    showLogin();
                } else {
                    alert('Falha ao alterar status.');
                }
            } catch (error) {
                console.error('Erro ao alternar status:', error);
            }
        }
        
        // --- FUNÇÃO PARA ABRIR MODAL EM MODO EDIÇÃO (PRESENTE) ---
        window.editGift = async function(giftId) {
            isEditingGift = true;
            errorMsgEl.style.display = 'none';
            successMsgEl.style.display = 'none';
            
            // 1. Buscando dados do presente
            try {
                // Endpoint /api/presentes/<id> é corrigido no app.py para ter autenticação
                const response = await fetch(`${API_BASE_URL}/api/presentes/${giftId}`, { headers: getAuthHeaders() });
                if (response.status === 404) throw new Error("Presente não encontrado.");
                if (response.status === 403) { showLogin(); return; }
                if (!response.ok) throw new Error("Erro ao carregar dados do presente.");

                const gift = await response.json();

                // 2. Preencher o Modal
                giftModalTitleEl.textContent = 'Editar Presente';
                saveGiftBtn.textContent = 'Atualizar Presente';
                
                giftIdInput.value = gift.id; // Guarda o ID no campo oculto
                giftNameInput.value = gift.nome_presente;
                giftValueInput.value = gift.valor_cota;
                giftUrlInput.value = gift.imagem_url;
                giftDescriptionInput.value = gift.descricao;
                
                // 3. Abrir o Modal
                addGiftModal.style.display = 'flex';

            } catch (error) {
                console.error('Erro ao editar presente:', error);
                alert('Não foi possível carregar os dados para edição.');
            }
        }


        // --- LÓGICA DO MODAL DE ADICIONAR/EDITAR PRESENTE ---
        const openModalBtn = document.getElementById('open-add-gift-modal');
        const closeModalBtn = document.getElementById('close-add-gift-modal');

        // Abre o modal em modo 'Criação'
        openModalBtn.addEventListener('click', () => {
            isEditingGift = false;
            addGiftModal.style.display = 'flex';
            giftModalTitleEl.textContent = 'Adicionar Novo Presente';
            saveGiftBtn.textContent = 'Salvar Presente';
            
            addGiftForm.reset(); // Limpa o formulário ao abrir
            giftUrlInput.value = "presente_padrao.png"; // Resetar o valor default
            giftIdInput.value = ''; // Garantir que o ID esteja limpo para criação
            
            errorMsgEl.style.display = 'none';
            successMsgEl.style.display = 'none';
        });
        
        closeModalBtn.addEventListener('click', () => addGiftModal.style.display = 'none');
        document.getElementById('cancel-add-gift').addEventListener('click', () => addGiftModal.style.display = 'none');
        
        // Envio do formulário (Criação ou Edição de Presente)
        addGiftForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsgEl.style.display = 'none';
            successMsgEl.style.display = 'none';
            
            const giftData = {
                nome_presente: giftNameInput.value,
                valor_cota: parseFloat(giftValueInput.value),
                imagem_url: giftUrlInput.value,
                descricao: giftDescriptionInput.value,
            };

            const method = isEditingGift ? 'PUT' : 'POST';
            const url = isEditingGift ? `${API_BASE_URL}/api/admin/presentes/${giftIdInput.value}` : `${API_BASE_URL}/api/admin/presentes`;
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(giftData)
                });
                
                if (response.ok) {
                    successMsgEl.textContent = isEditingGift ? 'Presente atualizado com sucesso!' : 'Presente adicionado com sucesso!';
                    successMsgEl.style.display = 'block';
                    loadGiftsTable(); // Recarrega a tabela
                    loadDashboardStats();
                    setTimeout(() => addGiftModal.style.display = 'none', 1500);
                } else if (response.status === 403) {
                     errorMsgEl.textContent = 'Falha de Autorização (403). Relogue.';
                     errorMsgEl.style.display = 'block';
                     showLogin();
                } else {
                    const error = await response.json();
                    errorMsgEl.textContent = error.mensagem || `Falha ao ${isEditingGift ? 'atualizar' : 'adicionar'} presente.`;
                    errorMsgEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro na operação de presente:', error);
                errorMsgEl.textContent = 'Erro de conexão com a API.';
                errorMsgEl.style.display = 'block';
            }
        });


        // --- INICIALIZAÇÃO ---
        // Tenta carregar o painel se já houver token
        if (localStorage.getItem('admin_token')) {
            showPanel();
        }
    </script>
</body>
</html>